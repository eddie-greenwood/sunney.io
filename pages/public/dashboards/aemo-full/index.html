<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="AEMO Complete Dashboard - Real-time Australian Energy Market Data | Greenwood Energy">
    <meta name="author" content="Greenwood Energy">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https:;">
    <link rel="icon" type="image/svg+xml" href="Greenwodo Icon.svg">
    <link rel="apple-touch-icon" href="Greenwodo Icon.svg">
    <link rel="mask-icon" href="Greenwodo Icon.svg" color="#00E87E">
    <title>AEMO Complete Dashboard - Full Market Data | Greenwood Energy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Greenwood Energy Brand Colors */
            --greenwood-primary: #00E87E;
            --greenwood-dark: #000000;
            --greenwood-light: #00FF8C;
            --greenwood-accent: #00C96A;
            --dark-bg: #0a0a0a;
            --card-bg: #141414;
            --card-border: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --white: #FFFFFF;
            
            /* AEMO specific colors */
            --accent-purple: #9b59b6;
            --accent-teal: #00bcd4;
            --accent-orange: #ff8800;
            --accent-red: #ff4444;
            --accent-yellow: #ffdd00;
            --accent-blue: #00aaff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #000000 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 232, 126, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(0, 232, 126, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease;
            position: relative;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .brand-row {
            position: relative;
            display: grid;
            grid-template-columns: 1fr 1fr;
            align-items: center;
            margin-bottom: 8px;
        }

        .brand-left {
            justify-self: start;
        }

        .brand-right {
            justify-self: end;
        }

        .logo-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            column-gap: 16px;
            justify-items: center;
            margin-bottom: 25px;
        }

        .logo {
            height: 50px;
            filter: drop-shadow(0 4px 6px rgba(0, 232, 126, 0.3));
            display: block;
        }

        .divider {
            height: 60px;
            width: 2px;
            background: linear-gradient(to bottom, transparent, var(--greenwood-primary), transparent);
            opacity: 0.8;
        }

        h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--greenwood-primary), var(--greenwood-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            letter-spacing: -1px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        /* Back to main dashboard link */
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #00E87E, #00C96A);
            color: #000;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 232, 126, 0.3);
            z-index: 1000;
        }

        .back-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 232, 126, 0.5);
            background: linear-gradient(135deg, #00FF8C, #00E87E);
        }

        /* Connection Status Card */
        .connection-status {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 232, 126, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.8s ease 0.2s both;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--greenwood-primary);
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(0, 232, 126, 0.5);
        }

        .status-dot.offline {
            background: var(--accent-red);
            animation: none;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        .data-info {
            display: flex;
            gap: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .data-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .data-info strong {
            color: var(--greenwood-primary);
        }

        /* Summary Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease 0.4s both;
        }

        .summary-card {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 232, 126, 0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--greenwood-primary), var(--greenwood-light));
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 232, 126, 0.2);
            border-color: rgba(0, 232, 126, 0.4);
        }

        .summary-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--greenwood-primary), var(--greenwood-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease 0.6s both;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Sections */
        .regions-section, .interconnectors-section {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 232, 126, 0.2);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 232, 126, 0.2);
        }

        .section-title {
            font-size: 1.3rem;
            background: linear-gradient(135deg, var(--greenwood-primary), var(--greenwood-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }

        /* Region Cards */
        .region-card {
            background: rgba(10, 10, 10, 0.6);
            border: 1px solid rgba(0, 232, 126, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .region-card:hover {
            background: rgba(10, 10, 10, 0.8);
            border-color: rgba(0, 232, 126, 0.3);
            transform: translateX(5px);
        }

        .region-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .region-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .region-code {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .region-price {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .price-positive { 
            color: var(--greenwood-primary);
            text-shadow: 0 0 10px rgba(0, 232, 126, 0.3);
        }
        
        .price-negative { 
            color: var(--accent-red);
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
        }
        
        .price-high { 
            color: var(--accent-orange);
            text-shadow: 0 0 10px rgba(255, 136, 0, 0.3);
        }

        /* Demand/Generation Bar Chart */
        .demand-gen-container {
            margin: 20px 0;
        }

        .demand-gen-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .demand-gen-bars {
            position: relative;
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid rgba(0, 232, 126, 0.1);
        }

        .demand-bar, .generation-bar {
            position: absolute;
            height: 19px;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .demand-bar {
            top: 0;
            background: linear-gradient(90deg, var(--accent-purple), #8e44ad);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .generation-bar {
            bottom: 0;
            background: linear-gradient(90deg, var(--accent-teal), #00acc1);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .bar-legend {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* FCAS Prices Grid */
        .fcas-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 232, 126, 0.1);
        }

        .fcas-item {
            background: rgba(0, 232, 126, 0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(0, 232, 126, 0.1);
            transition: all 0.3s ease;
        }

        .fcas-item:hover {
            background: rgba(0, 232, 126, 0.1);
            border-color: rgba(0, 232, 126, 0.3);
        }

        .fcas-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fcas-value {
            font-size: 0.95rem;
            font-weight: bold;
            color: var(--greenwood-primary);
        }

        /* Interconnector Items */
        .interconnector-item {
            background: rgba(10, 10, 10, 0.6);
            border: 1px solid rgba(0, 232, 126, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .interconnector-item:hover {
            background: rgba(10, 10, 10, 0.8);
            border-color: rgba(0, 232, 126, 0.3);
            transform: translateX(5px);
        }

        .interconnector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .interconnector-name {
            font-weight: bold;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .interconnector-flow {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .flow-export { 
            color: var(--greenwood-primary);
            text-shadow: 0 0 10px rgba(0, 232, 126, 0.3);
        }
        
        .flow-import { 
            color: var(--accent-orange);
            text-shadow: 0 0 10px rgba(255, 136, 0, 0.3);
        }
        
        .flow-neutral { 
            color: var(--text-secondary);
        }
        
        .flow-at-limit { 
            color: var(--accent-red);
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
        }

        .interconnector-limits {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .flow-bar-container {
            position: relative;
            height: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
            border: 1px solid rgba(0, 232, 126, 0.1);
        }

        .flow-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--greenwood-primary));
            transition: all 0.5s ease;
            left: 50%;
            transform: translateX(-50%);
        }

        .flow-bar.export {
            background: linear-gradient(90deg, transparent, var(--greenwood-primary));
            transform-origin: left;
        }

        .flow-bar.import {
            background: linear-gradient(90deg, var(--accent-orange), transparent);
            transform-origin: right;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            animation: fadeIn 0.8s ease 0.8s both;
        }

        button {
            background: linear-gradient(135deg, var(--greenwood-primary), var(--greenwood-accent));
            color: var(--greenwood-dark);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 232, 126, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 232, 126, 0.5);
            background: linear-gradient(135deg, var(--greenwood-light), var(--greenwood-primary));
        }

        button:active {
            transform: translateY(0);
        }

        /* Error Container */
        .error-container {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            display: none;
            color: var(--accent-red);
            animation: shake 0.5s ease;
        }

        .error-container.show {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Last Update */
        .last-update {
            text-align: center;
            color: var(--text-secondary);
            margin-top: 20px;
            font-size: 0.9rem;
            animation: fadeIn 0.8s ease 1s both;
        }

        /* Loading State */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 1rem;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }

            .fcas-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .back-link {
                top: 10px;
                left: 10px;
                padding: 8px 15px;
                font-size: 0.8rem;
            }

            .logo {
                height: 40px;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Back to main dashboard -->
    <a href="/" class="back-link">
        ← Back to Lé Tool
    </a>

    <div class="dashboard">
        <div class="header">
            <div class="logo-container">
                <img src="GreenwoodEnergy Logoo.svg" alt="Greenwood Energy" class="logo brand-left">
                <div class="divider"></div>
                <img src="Greenwodo Icon.svg" alt="Greenwood Icon" class="logo brand-right">
            </div>
            <h1>AEMO Complete Dashboard</h1>
            <div class="subtitle">Full Market Data Replication - Energy, FCAS, Demand/Generation & Interconnectors</div>
        </div>

        <div class="connection-status">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <div class="data-info">
                <span>Settlement: <strong id="settlementTime">--:--</strong></span>
                <span>Source: <strong id="dataSource">--</strong></span>
                <span>Auto-refresh: <strong>60s</strong></span>
            </div>
        </div>

        <div id="errorContainer" class="error-container"></div>

        <!-- Summary Statistics -->
        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-label">Total NEM Demand</div>
                <div class="summary-value" id="totalDemand">-- MW</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Total Generation</div>
                <div class="summary-value" id="totalGeneration">-- MW</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Average Spot Price</div>
                <div class="summary-value" id="avgPrice">$--</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Net Interchange</div>
                <div class="summary-value" id="netInterchange">-- MW</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Regions Section -->
            <div class="regions-section">
                <div class="section-header">
                    <span class="section-title">⚡ Regional Markets</span>
                </div>
                <div id="regionsContainer">
                    <!-- Region cards will be populated here -->
                </div>
            </div>

            <!-- Interconnectors Section -->
            <div class="interconnectors-section">
                <div class="section-header">
                    <span class="section-title">🔗 Interconnector Flows</span>
                </div>
                <div id="interconnectorsContainer">
                    <!-- Interconnector data will be populated here -->
                </div>
            </div>
        </div>

        <div class="last-update">
            Last updated: <span id="lastUpdate">Never</span>
        </div>

        <div class="controls">
            <button onclick="refreshData()">🔄 Refresh Now</button>
            <button id="pauseBtn" onclick="toggleAutoRefresh()">⏸ Pause</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://aemo-unified-source.eddie-37d.workers.dev/api/latest';
        const REGIONS = ['QLD1', 'NSW1', 'VIC1', 'SA1', 'TAS1'];
        const REGION_NAMES = {
            'QLD1': 'Queensland',
            'NSW1': 'New South Wales',
            'VIC1': 'Victoria',
            'SA1': 'South Australia',
            'TAS1': 'Tasmania'
        };

        const INTERCONNECTOR_NAMES = {
            'N-Q-MNSP1': 'QLD → NSW (Terranora)',
            'NSW1-QLD1': 'NSW → QLD',
            'V-S-MNSP1': 'VIC → SA (Murraylink)',
            'VIC1-NSW1': 'VIC → NSW',
            'V-SA': 'VIC → SA',
            'SA1-VIC1': 'SA → VIC',
            'T-V-MNSP1': 'TAS → VIC (Basslink)',
            'TAS1-VIC1': 'TAS → VIC'
        };

        let autoRefreshInterval;
        let isPaused = false;

        // Initialize dashboard
        async function init() {
            console.log('Initializing complete dashboard...');
            await refreshData();
            startAutoRefresh();
        }

        // Fetch and display data
        async function refreshData() {
            console.log('Fetching latest data...');
            const dashboard = document.querySelector('.dashboard');
            dashboard.classList.add('loading');

            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Data received:', data);

                // Update connection status
                updateConnectionStatus(true);

                // Check if we have full dashboard data or simple data
                if (data.regions && data.interconnectors) {
                    // Full dashboard data
                    updateFullDashboard(data);
                } else if (data.regions) {
                    // Simple data fallback
                    console.log('Calling updateSimpleDashboard (fallback)');
                    updateSimpleDashboard(data);
                }

                // Update last update time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

                // Clear any errors
                document.getElementById('errorContainer').innerHTML = '';
                document.getElementById('errorContainer').classList.remove('show');

            } catch (error) {
                console.error('Error fetching data:', error);
                updateConnectionStatus(false);
                showError(`Failed to fetch data: ${error.message}`);
            } finally {
                dashboard.classList.remove('loading');
            }
        }

        // Update full dashboard with comprehensive data
        function updateFullDashboard(data) {
            // Update settlement time and source
            document.getElementById('settlementTime').textContent = 
                data.settlementTime ? formatSettlementTime(data.settlementTime) : '--:--';
            document.getElementById('dataSource').textContent = 'Full MMS';

            // Update regions
            const regionsContainer = document.getElementById('regionsContainer');
            regionsContainer.innerHTML = '';

            let totalDemand = 0;
            let totalGeneration = 0;
            let totalNetInterchange = 0;
            let priceSum = 0;
            let priceCount = 0;

            REGIONS.forEach(region => {
                const regionData = data.regions[region];
                if (!regionData) return;

                // Use totalDemand for demand total, dispatchableGeneration for generation total
                const demandValue = regionData.totalDemand || regionData.scheduledDemand || 0;
                const generationValue = regionData.dispatchableGeneration || 0;

                totalDemand += demandValue;
                totalGeneration += generationValue;
                totalNetInterchange += regionData.netInterchange || 0;

                if (regionData.energyPrice) {
                    priceSum += regionData.energyPrice;
                    priceCount++;
                }

                // For display bars, use scheduledDemand and dispatchableGeneration
                const displayDemand = regionData.scheduledDemand || regionData.totalDemand || 0;
                const displayGen = regionData.dispatchableGeneration || 0;
                const maxValue = Math.max(displayDemand, displayGen) || 1000;
                const demandPercent = (displayDemand / maxValue * 100).toFixed(1);
                const genPercent = (displayGen / maxValue * 100).toFixed(1);

                const card = document.createElement('div');
                card.className = 'region-card';
                card.innerHTML = `
                    <div class="region-header">
                        <div>
                            <div class="region-name">${REGION_NAMES[region]}</div>
                            <div class="region-code">${region}</div>
                        </div>
                        <div class="region-price ${getPriceClass(regionData.energyPrice)}">
                            $${regionData.energyPrice ? regionData.energyPrice.toFixed(2) : '--'}
                        </div>
                    </div>
                    
                    <div class="demand-gen-container">
                        <div class="demand-gen-label">
                            <span>Demand: ${Math.round(displayDemand).toLocaleString()} MW</span>
                            <span>Generation: ${Math.round(displayGen).toLocaleString()} MW</span>
                        </div>
                        <div class="demand-gen-bars">
                            <div class="demand-bar" style="width: ${demandPercent}%"></div>
                            <div class="generation-bar" style="width: ${genPercent}%"></div>
                        </div>
                        <div class="bar-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--accent-purple)"></div>
                                <span>Scheduled Demand</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--accent-teal)"></div>
                                <span>Scheduled Generation</span>
                            </div>
                        </div>
                    </div>
                    
                    ${regionData.fcas ? `
                    <div class="fcas-grid">
                        <div class="fcas-item">
                            <div class="fcas-label">Raise Reg</div>
                            <div class="fcas-value">$${regionData.fcas.raiseReg.toFixed(2)}</div>
                        </div>
                        <div class="fcas-item">
                            <div class="fcas-label">Lower Reg</div>
                            <div class="fcas-value">$${regionData.fcas.lowerReg.toFixed(2)}</div>
                        </div>
                        <div class="fcas-item">
                            <div class="fcas-label">Raise 6s</div>
                            <div class="fcas-value">$${regionData.fcas.raise6sec.toFixed(2)}</div>
                        </div>
                        <div class="fcas-item">
                            <div class="fcas-label">Lower 6s</div>
                            <div class="fcas-value">$${regionData.fcas.lower6sec.toFixed(2)}</div>
                        </div>
                        <div class="fcas-item">
                            <div class="fcas-label">Raise 60s</div>
                            <div class="fcas-value">$${regionData.fcas.raise60sec.toFixed(2)}</div>
                        </div>
                        <div class="fcas-item">
                            <div class="fcas-label">Lower 60s</div>
                            <div class="fcas-value">$${regionData.fcas.lower60sec.toFixed(2)}</div>
                        </div>
                        <div class="fcas-item">
                            <div class="fcas-label">Raise 5m</div>
                            <div class="fcas-value">$${regionData.fcas.raise5min.toFixed(2)}</div>
                        </div>
                        <div class="fcas-item">
                            <div class="fcas-label">Lower 5m</div>
                            <div class="fcas-value">$${regionData.fcas.lower5min.toFixed(2)}</div>
                        </div>
                    </div>
                    ` : ''}
                `;

                regionsContainer.appendChild(card);
            });


            // Recalculate totals correctly
            let correctTotalDemand = 0;
            let correctTotalGeneration = 0;
            
            REGIONS.forEach(region => {
                const regionData = data.regions[region];
                if (regionData) {
                    correctTotalDemand += (regionData.totalDemand || 0);
                    correctTotalGeneration += (regionData.dispatchableGeneration || 0);
                }
            });
            
            console.log('CORRECT TOTALS:', {
                demand: correctTotalDemand,
                generation: correctTotalGeneration,
                difference: correctTotalGeneration - correctTotalDemand
            });

            // Update summary stats with correct values
            document.getElementById('totalDemand').textContent = Math.round(correctTotalDemand).toLocaleString() + ' MW';
            document.getElementById('totalGeneration').textContent = Math.round(correctTotalGeneration).toLocaleString() + ' MW';
            document.getElementById('avgPrice').textContent = priceCount > 0 ? 
                '$' + (priceSum / priceCount).toFixed(2) : '$--';
            document.getElementById('netInterchange').textContent = 
                (totalNetInterchange >= 0 ? '+' : '') + Math.round(totalNetInterchange).toLocaleString() + ' MW';

            // Update interconnectors
            if (data.interconnectors) {
                updateInterconnectors(data.interconnectors);
            }
        }

        // Update simple dashboard (fallback)
        function updateSimpleDashboard(data) {
            document.getElementById('settlementTime').textContent = 
                data.settlementTime ? formatSettlementTime(data.settlementTime) : '--:--';
            document.getElementById('dataSource').textContent = data.source || 'Unknown';

            const regionsContainer = document.getElementById('regionsContainer');
            regionsContainer.innerHTML = '';

            let totalDemand = 0;
            let totalGeneration = 0;  // Fix: declare this variable
            let priceSum = 0;
            let priceCount = 0;

            Object.entries(data.regions).forEach(([region, regionData]) => {
                // Handle both old format (demand) and new format (scheduledDemand)
                const demandValue = regionData.scheduledDemand || parseFloat(regionData.demand) || regionData.totalDemand || 0;
                const genValue = regionData.dispatchableGeneration || regionData.scheduledGeneration || 0;
                totalDemand += demandValue;
                totalGeneration += genValue;

                // Handle both old format (energy) and new format (energyPrice)
                if (regionData.energy || regionData.energyPrice) {
                    const price = regionData.energyPrice !== undefined ? regionData.energyPrice : parseFloat(regionData.energy);
                    priceSum += price;
                    priceCount++;
                }

                const card = document.createElement('div');
                card.className = 'region-card';
                card.innerHTML = `
                    <div class="region-header">
                        <div>
                            <div class="region-name">${REGION_NAMES[region] || region}</div>
                            <div class="region-code">${region}</div>
                        </div>
                        <div class="region-price ${getPriceClass(regionData.energyPrice || parseFloat(regionData.energy))}">
                            $${(regionData.energyPrice || parseFloat(regionData.energy)).toFixed(2)}
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px; font-size: 0.95rem; color: var(--text-secondary);">
                        Demand: <strong style="color: var(--greenwood-primary);">${Math.round(demandValue).toLocaleString()} MW</strong>
                    </div>
                    
                    ${regionData.fcas ? `
                    <div class="fcas-grid">
                        ${Object.entries(regionData.fcas).map(([key, value]) => `
                            <div class="fcas-item">
                                <div class="fcas-label">${formatFCASName(key)}</div>
                                <div class="fcas-value">$${parseFloat(value).toFixed(2)}</div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                `;

                regionsContainer.appendChild(card);
            });

            // Update summary
            document.getElementById('totalDemand').textContent = totalDemand > 0 ? 
                Math.round(totalDemand).toLocaleString() + ' MW' : '-- MW';
            document.getElementById('totalGeneration').textContent = totalGeneration > 0 ? 
                Math.round(totalGeneration).toLocaleString() + ' MW' : '-- MW';
            document.getElementById('avgPrice').textContent = priceCount > 0 ? 
                '$' + (priceSum / priceCount).toFixed(2) : '$--';
            document.getElementById('netInterchange').textContent = '-- MW';
        }

        // Update interconnector flows
        function updateInterconnectors(interconnectors) {
            const container = document.getElementById('interconnectorsContainer');
            container.innerHTML = '';

            if (!interconnectors || Object.keys(interconnectors).length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">No interconnector data available</div>';
                return;
            }

            Object.entries(interconnectors).forEach(([id, data]) => {
                const flowValue = data.mwFlow || 0;
                const flowDirection = flowValue > 0 ? 'export' : flowValue < 0 ? 'import' : 'neutral';
                const flowClass = data.atLimit ? 'flow-at-limit' : `flow-${flowDirection}`;

                const item = document.createElement('div');
                item.className = 'interconnector-item';
                item.innerHTML = `
                    <div class="interconnector-header">
                        <div class="interconnector-name">${INTERCONNECTOR_NAMES[id] || id}</div>
                        <div class="interconnector-flow ${flowClass}">
                            ${flowValue >= 0 ? '→' : '←'} ${Math.abs(flowValue).toFixed(0)} MW
                        </div>
                    </div>
                    
                    <div class="flow-bar-container">
                        <div class="flow-bar ${flowDirection}" 
                             style="width: ${Math.min(100, Math.abs(flowValue) / Math.max(data.exportLimit, data.importLimit) * 100)}%">
                        </div>
                    </div>
                    
                    <div class="interconnector-limits">
                        <span>Import: ${data.importLimit.toFixed(0)} MW</span>
                        <span>${data.atLimit ? '⚠️ AT LIMIT' : ''}</span>
                        <span>Export: ${data.exportLimit.toFixed(0)} MW</span>
                    </div>
                `;

                container.appendChild(item);
            });
        }

        // Helper functions
        function getPriceClass(price) {
            if (price < 0) return 'price-negative';
            if (price > 150) return 'price-high';
            return 'price-positive';
        }

        function formatSettlementTime(time) {
            if (time.includes(' ')) {
                return time.split(' ')[1].substring(0, 5);
            }
            return time;
        }

        function formatFCASName(key) {
            const names = {
                'raiseReg': 'Raise Reg',
                'lowerReg': 'Lower Reg',
                'raise6sec': 'Raise 6s',
                'lower6sec': 'Lower 6s',
                'raise60sec': 'Raise 60s',
                'lower60sec': 'Lower 60s',
                'raise5min': 'Raise 5m',
                'lower5min': 'Lower 5m'
            };
            return names[key] || key;
        }

        // Connection status
        function updateConnectionStatus(online) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');

            if (online) {
                dot.classList.remove('offline');
                text.textContent = 'Connected';
            } else {
                dot.classList.add('offline');
                text.textContent = 'Offline';
            }
        }

        // Error handling
        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `⚠️ ${message}`;
            container.classList.add('show');
        }

        // Auto refresh
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                if (!isPaused) {
                    refreshData();
                }
            }, 60000); // 60 seconds
        }

        function toggleAutoRefresh() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            btn.textContent = isPaused ? '▶️ Resume' : '⏸ Pause';
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>